# 3장(1)

# 코드에서 나는 악취

리팩토링이 필요한, 아주 절실한 코드들에는 일정한 패턴이 있다. 이 장은 그러한 패턴들을 쭉 설명해주고 있다.

또한, 필자는 인스턴스 변수는 몇 개가 적당한지, 메서드가 몇 줄을 넘어가면 안 좋은지 등은 각자 경험을 통해 감을 키워야한다고 조언한다.

## 3.1 기이한 이름

- 코드는 궁금증을 자아내면 안된다.
    - 함수, 모듈, 변수, 클래스 등은 그 이름만 보고도 각각이 무슨 일을 하고 어떻게 사용해야 하는지 명확히 알 수 있도록 엄청나게 신경 써서 이름을 지어야한다.
- 이름을 바꾸는 기법
    - 함수 선언 바꾸기
    - 변수 이름 바꾸기
    - 필드 이름 바꾸기
- 마땅한 이름이 떠오르지 않는다면 설계에 더 근본적인 문제가 숨어 있을 가능성이 높다. **그래서 혼란스러운 이름을 잘 정리하다 보면 코드가 훨씬 간결해질 때가 많다.**

## 3.2 중복 코드

코드가 중복되면 각각을 볼 때마다 서로 차이점은 없는지 주의 깊게 살펴봐야 하는 부담이 생긴다. 그중 하나를 변경할 때는 다른 비슷한 코드들도 모두 살펴보고 적절히 수정해야 한다.

- 중복코드를 없애는 기법
    - 함수 추출하기
    - 문장 슬라이드하기
    - 메서드 올리기

## 3.3 긴 함수

짧은 함수들로 구성된 코드 베이스를 얼핏 훑으면 연산하는 부분이 하나도 없어 보인다. 코드가 끝없이 위임하는 방식으로 작성되어 있기 때문이다. → 이런 코드들을 수년 다루다보면 **짧은 함수가 얼마나 중요한지 깨닫게 된다.**

간접호출 (indirection)의 효과, 즉 코드를 이해하고, 공유하고, 선택하기 쉬워진다는 장점은 함수를 짧게 구성할 때 나오는 것이다. 

함수 파악을 위해서 왔다갔다 하는 것은 사용자한테 부담을 줄 수 는있지만 ⭐ 좋은 이름을 사용하면 본코드를 깊숙히 보지 않아도 된다. 

함수를 추출해야하는 순간

- 주석이 필요하다면 추출해라
- 조건문이 있다면 추출해라
    - 같은 조건을 기준으로 나뉘는 switch문이 여러개라면 조건문을 다형성으로 바꾸기(10.4절)를 적용
- 반복문이 있다면 추출해라

## 3.4 긴 매개변수 목록

함수에 매개변수가 줄줄이 따라다니면 그 자체로 이해하기가 어렵다. 

우리가 프로그래밍을 시작하던 시절에는 함수에 필요한 것들을 모조리 매개변수로 전달하라고 배웠다. 그래야 암적 존재인 전역데이터가 늘어나는 사태를 막을 수 있었기 때문에... 그시절 합리적 방식 이었다..

하지만 이제는 다르다 ~~

매개변수를 바꾸는 방법

- 매개변수를 질의 함수로 바꾸기 (11.5절)
- 객체 통째로 넘기기
- 매개변수 객체 만들기
- 플래그 인수 제거하기

클래스는 매개변수 목록을 줄이는 데 효과적인 수단이기도 하다.

## 3.5 전역 데이터

전역데이터는 지옥에서 온 놈이다..

전역 데이터는 코드베이스 어디에서든 건드릴 수 있고, 값을 누가 바꿨는지 찾아낼 메커니즘이 없다는 게 문제다.

전역데이터의 대표적인 형태

- 전역 변수
- 클래스 변수
- 싱글톤

전역 데이터의 문제를 방지하는 방법

- 변수 캡슐화 하기 (6.6절)
    - 다른 코드에서 오염시킬 가능성이 있는 데이터를 발견할때마다 이 기법을 가장 먼저 적용한다.
- 접근자 함수들을 클래스나 모듈에 집어넣고 그 안에서만 사용할 수 있도록 접근범위를 최소로 줄인다.

전역데이터가 가변(Mutable)이라면 특히나 다루기 까다롭다. 프로그램이 구동된 후에는 값이 바뀌지 않는다고 보장할 수 있는 전역 데이터는 그나마 안전한 편이다. 물론 언어에서 이런 기능을 제공해야 한다. 

전역데이터가 조금이라면 감당가능. 하지만 많으면 걷잡을 수 없게된다. 아무튼 지독한 놈이다..

## 3.6 가변 데이터

데이터를 변경했더니 예상치 못한 결과로 이어지는 버그가 있다. 

모든 프로그래머가 함수형 언어를 쓰는 것은 아니기 떄문에, 무분별한 데이터 수정에 따른 위험을 줄이는 방법을 알아야 한다.

- 변수 캡슐화하기
- 변수 쪼개기
    - 하나의 변수에 용도가 다른 값들을 저장하는 경우, 각 경우에 맞게 변수를 쪼갠다
- 문장 슬라이드 하기 & 함수 추출하기
    - 갱신 로직은 다른코드와 떨어뜨려 놓는 것이 좋다.
- 질의 함수와 변경 함수 분리하기
    - 꼭 필요한 경우가 아니라면 부작용이 있는 코드를 호출할 수 없게 한다.
- 세터 제거하기
- 파생 변수를 질의 함수로 바꾸기 (9.3절)
    - 값을 다른 곳에서 설정할 수 있는 가변데이터가 풍기는 악취는 특히 고약하다.
- 변수를 변환할 수 있는 코드들의 유효범위를 제한한다.
    - 여러 함수를 클래스로 묶기(6.9절)
    - 여러 함수를 변환 함수로 묶기(6.10절)

## 3.7 뒤엉킨 변경

하나의 변경이 여러가지의 수정을 만들때.

뒤엉킨 변경은 단일책임원칙이 제대로 지켜지지 않을때 나타단다. 즉, 하나의 모듈이 서로 다른 이유들로 인해 여러가지 방식으로 변경되는 일이 많을 때 발생한다.

뒤엉킨 변경에서는 모듈을 맥락별로 분리하라.

- 단계 쪼개기
    - 데이터를 특정한 데이터 구조에 담아 전달하게 하는 식으로 단계를 분리
- 함수 옮기기
    - 각 맥락에 해당하는 적당한 모듈들을 만들어서 관련 함수들을 모은다.
- 함수 추출하기
    - 여러 맥락의 일에 관련하는 함수가 있다면 옮기기 전에 함수부터 추출해라.
- 클래스 추출하기
    - 모듈이 클래스라면 클래스를 추출해라.

## 3.8 산탄총 수술

코드를 변경할 때마다 자잘하게 수정해야하는 클래스가 많을때.

뒤엉킨 변경과 비슷하면서도 다르다.

변경해야할 부분이 코드 절반에 퍼져 있다면 찾기도 어렵고, 꼭 수정해야 할 곳을 지나치기 쉽다. 

산탄총수술의 경우 모듈을 맥락별로 모아라

- 함수 옮기기
- 필드 옮기기
    - 함께 변경이 되는 대상들을 모두 한 모듈로 묶어두면 좋다.
- 함수 인라인하기
- 클래스 인라인하기
    - 어설프게 분리된 로직을 인라인 리팩터링으로 하나로 합친다.

사실 우리는 작은 함수와 클래스에 지나치게 집착하지만, 코드를 재구성하는 중간 과정에서는 큰 덩어리로 뭉쳐지는데 게의치 않아야한다.

## 3.9 기능 편애

기능 편애는 프로그램을 어떤 함수가 자기가 속한 모듈의 함수나 데이터보다, 다른 모듈의 함수나 데이터와 상호작용 할 일이 더 많을때 풍기는 악취이다.

기능편애를 해결하기 위해서는

- 함수 옮기기
    - 소원대로 데이터 근처로 옮겨주면 된다.
- 함수 추출하기 & 함수 옮기기
    - 일부의 기능만 편애할 수 있다, 이럴때는 추출후에 옮겨주면 된다.

## 3.10 데이터 뭉치

흩뿌려져 있는 데이터를 데이터 뭉치로 만들어 준다.

- 클래스 추출하기
- 매개변수 객체 만들기
- 객체 통째로 넘기기

## 3.11 기본형 집착

대부분 프로그래밍 언어는 기본형을 제공한다.

한편 프로그래머 중에는 자신에게 주어진 문제에 딱맞는 기초 타입(화폐, 좌표, 구간, 전화번호 등) 을 직접 정의하기 몹시 꺼리는 사람이 많다. 

하지만 전화번호를 단순히 문자 집합으로만 표현하기엔 아쉬움이 많다. 최소한 사용자에게 보여줄 때는 일관된 형식으로 출력해주는 기능이라도 갖춰야한다. 

- 기본형을 객체로 바꾸기 (7.3절)
- 타입코드를 서브 클래스로 바꾸기(12.6절) & 조건부 로직을 다형성으로 바꾸기(10.4절)
    - 기본형으로 표현된 코드가 조건부 동작을 제어하는 타입 코드로 쓰였다면.

## 3.12 반복되는 switch문

switch문이 문제가 되는 이유는 조건절 하나 추가할 때마다 다른 switch문들도 모두 찾아서 함께 수정해야하기 때문이다.

switch문은 사악하다. 

- 조건부 로직을 다형성으로 바꾸기(10.4절)